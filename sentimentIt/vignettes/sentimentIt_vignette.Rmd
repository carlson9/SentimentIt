---
title: "SentimentIt"
author: ""
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{sentimentIt_vignette}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

This is a tutorial on how to use the SentimentIt R package. SentimentIt provides a pairwise comparison framework for fast, flexible, and reliable human coding of political texts.

###Probably want to include some background on SentimentIt here###


Create the necessary accounts
------

Before interacting with the package in R, go to the following link: https://www.sentimentit.com/documentation/getting_started. The manual attached to the link explains how to create the necessary accounts with Amazon and SentimentIt so you can interact with Mechanical Turk. A SentimentIt account MUST be created before the SentimentIt R package can be used. 


Install/load the SentimentIt R package
------

Once the five steps of the SentimentIt manual are completed, install the SentimentIt package in R using the following command:

```{r, eval = FALSE}
install.packages("SentimentIt")

#or if the package is already installed
library("SentimentIt")
```


Assign ID numbers to data objects
------

Once the package is installed, you need to prepare your data for the pairwise comparisons. The first step is to assign unique ID numbers to each object of comparison using the `readText()` function. 

The `readText()` function will take the data as an input, import it into the SentimentIt repository, and assign unique ID values to each object in the data. The function will then export the data to a specified file path, complete with ID numbers. If any objects already exist in the repository, the ID number for the existing object will be used instead of importing a duplicate.

Your data should contain the set of objects you want to perform pairwise comparisons on. It may contain other data as well, but you will need to specify which column contains the data to be used in the pairwise comparisons. The best practice for running this function is to first import your data into your R workspace before running the function.

The following example uses a sample dataset, "reviews.rda", to show how to use the `readText()` function to assign unique ID numbers

```{r, eval = FALSE}
load("/Users/johndoe/Desktop/reviews.rda") #data is stored in R workspace as "reviews"

#assign an object name to the function so the data with IDs will be stored in your R workspace in addition to being exported to your desired filepath. In this case, I have assigned the output the name "reviews_with_ids"
reviews_with_ids <- readText(email = "johndoe@school.edu", password = "12345",
         read_documents_from = reviews,
         write_documents_to = "/Users/johndoe/Desktop/reviews_with_ids.csv",
         index = "Review") #"Review" is the column name for the data I want to use in the comparison
```

`readText()` accepts the following arguments:

-   `email`: Character vector, the email address for the registered SentimentIt account.

-   `password`: Character vector, the password associated with `email`.

-   `read_documents_from`: The name of the R object the data is being drawn from. Can also be a character vector  indicating a filepath.

-   `write_documents_to`: The file path to write the `read_documents_from` object appended with the unique IDs. Default is NULL and the results will not be saved, but only returned. For best functionality specify a csv.

-   `index`: If the data is tabular, this field should contain either a character vector or integer identifying the column name of the data to be used in the comparisons. Default is `NULL`, indicating the text was not sent in tabular format.

-   `sep`: Argument passed to `read.table()` function. If using an R workspace object, do not edit this field. Default is line break. Only needed when index is not `NULL`.

-   `what`: Argument passed to `scan()` function. Default is character. Only needed when index is NULL.

-   `quiet`: Argument passed to `scan()` function. Default is TRUE. Only needed when index is NULL.

-   `...`: Additional arguments passed to either `scan()` or `read.table()` depending on type of data used.


Generate random pairs of IDs for comparisons
------

At this point, the data with unique IDs should be stored both in your R workspace and in the filepath you specified in `readText()`. The next step is to create unique batch ID numbers. Each batch ID number will be associated with a "batch",
which contains a portion of all comparisons to be sent to Mechanical Turk. Instead of sending all comparisons to Mechanical Turk at once, you can decide to release each batch at your discretion. 

To create unique batch ID numbers, use the `createBatches()` function. Before using this function, you should have set up HIT settings on the SentimentIt website. You will need to provide the ID number of the specific HIT settings you would like to use for the comparisons. If you have not set up any HIT settings by this point, refer to the following documentation: https://www.sentimentit.com/documentation/running_analysis. 

```{r, eval = FALSE}


batch_ids <- createBatches(email = "johndoe@school.edu", password = "12345",
              task_setting_id = 28, num_batches = 3)
```

`createBatches()` accepts the following arguments:

-   `email`: Character vector, the email address for the registered SentimentIt account.

-   `password`: Character vector, the password associated with `email`.

-   `task_setting_id`: Integer vector, the ID number of the HIT settings you would like to use for these batches of comparisons.

-   `num_batches`: Integer vector, the number of separate batches in which you would like to send the comparisons to Mechanical Turk. Default to 1. 


Fill batches with comparisons
------

At this point, you should have run both the `readText()` and `createBatches()` functions and you should have data with unique IDs. You should also have as many unique batch IDs as the number of batches you would like to send out the comparisons in. The next step is to fill these batches with random pairings of your data objects. Each batch you send to Mechanical Turk will contain these random pairings and MTurk workers will compare some latent trait between the paired objects.

To generate these random pairings, run the `makeComps()` function, which will generate random pairings of your data objects and distribute them evenly among the number of batches you specify. Before running this function, you should have your unique batch ID numbers stored in your R workspace and you should have decided what quality you want to compare between the paired objects, which should be specified in the `question` input.

Once the comparisons have been generated, they will be stored in the SentimentIt server and sent to Mechanical Turk when you direct them to. The function should return a vector of the batch IDs you provided. If not, the function did not correctly set up your batches. 

```{r, eval = FALSE}

makeComps(email = "johndoe@school.edu", password = "12345",
             ids = reviews_ids[,3], number_per = 10,
             batch_id = batch_ids,
             question = "Below are two movie reviews. Identify which review you think is more positive.",
             pairwise_path = "comparisons.Rdata")
```

`makeComps()` accepts the following arguments:

-   `email`: Character vector, the email address for the registered SentimentIt account.

-   `password`: Character vector, the password associated with `email`.

-   `ids`: Integer vector, the ID numbers of the texts you want to use.

-   `number_per`: Integer vector, how many documents per batch to be compared.

-   `batch_id`: Numeric vector, the unique batch ID numbers you generated in `createBatches()`.

-   `question`: Character vector, the question the worker will see when comparing the texts.

-   `pairwise_path`: Character vector, the filepath to save the created pairwise matrix. Default is "pairwise.Rdata".


Send batches to Mechanical Turk
------

At this point, you should have run the `readText()`, `createBatches()`, and `makeComps()` functions and should therefore have pairwise comparisons set up under batches in the SentimentIt server. You are now prepared to send your batches to Mechanical Turk to have workers complete the pairwise comparisons of the data. 

To send batches to Mechanical Turk, use the `createTasks()` function. As you can see in the below example, you can determine which batches you would like to send to Mechanical Turk by only speficying those specific batch IDs. You do not need to send them all at once.

Note that when you run this function, workers will automatically be paid for the work they do in that batch, regardless of the quality of their work. In the SentimentIt system, any worker who completes a task is automatically paid every 24 hours.

```{r, eval = FALSE}

createTasks(email = "johndoe@school.edu", password = "12345",
            batch_id = batch_ids[1]) #the batch_id object contains three unique batch IDs, but we are only sending the                                          first one to Mechanical Turk
```

`createTasks()` accepts the following arguments:

-   `email`: Character vector, the email address for the registered SentimentIt account.

-   `password`: Character vector, the password associated with `email`.

-   `batch_id`: Numeric vector, the unique batch ID numbers you generated in `createBatches()`. Only specify the ID numbers for the batches you want to submit to Mechanical Turk now. Batches can be released at separate times.


Check the status of a batch in Mechanical Turk
------

Once you have submitted batches of comparisons to Mechanical Turk, you can check their status to see how many comparisons in the batch have been completed. This can be done using the `checkBatches()` function. To check the status of a batch, all you need is the batch ID number.

```{r, eval = FALSE}

batchStatus(email = "johndoe@school.edu", password = "12345",
              batch_id = batch_ids[1])
```

`batchStatus()` accepts the following arguments:

-   `email`: Character vector, the email address for the registered SentimentIt account.

-   `password`: Character vector, the password associated with `email`.

-   `batch_id`: Numeric vector, the ID number associated with a batch of comparisons you have already sent to Mechanical Turk.


Read in data for completed comparisons from SentimentIt
------

Once you have sent the batches to Mechanical Turk using `createTasks()` and allowed some time for comparisons to be completed, you can retrieve data on the batches you sent. To retrieve this data, use the `readInData()` function. 

You must specify a batch ID to the function, and the function will return a data frame containing the batch ID, comparison ID, document ID, result of the comparison, ID of the task, ID of the worker who completed the task, and the time when the task was completed.

```{r, eval = FALSE}

comp_output <- readInData(email = "johndoe@school.edu", password = "12345",
              batch_id = batch_ids[1])
```

`readInData()` accepts the following arguments:

-   `email`: Character vector, the email address for the registered SentimentIt account.

-   `password`: Character vector, the password associated with `email`.

-   `batch_id`: Numeric vector, the ID number associated with a batch of comparisons you have already sent to Mechanical Turk and would like to retrieve data on.


Repost expired tasks from a batch to Mechanical Turk
------

When batches of comparisons are submitted to Mechanical Turk, some comparisons may not be completed before the batch expires. These incomplete tasks can be reposted to Mechanical Turk using the `repostExpired()` function.

```{r, eval = FALSE}

repostExpired(email = "johndoe@school.edu", password = "12345",
              batch_id = batch_ids[1])
```

`batchStatus()` accepts the following arguments:

-   `email`: Character vector, the email address for the registered SentimentIt account.

-   `password`: Character vector, the password associated with `email`.

-   `batch_id`: Numeric vector, the ID number associated with the expired batch containing the incomplete comparisons you would like to repost.


Estimate Stan model for worker reliability
------

Once you have sent batches of comparisons to Mechanical Turk and retrieved the results, you can estimate the reliability of the workers completing each task using a Stan model. For more information on Stan models, refer to page 7 of the following paper: https://www.sentimentit.com/SentimentIt.pdf (Carlson + Montgomery).

You can fit either a non-hierarchical or a hierarchical Stan model. To estimate a non-hierarchical Stan model, use the `fitStan()` function. To estimate a hierarchical Stan model, use the `fitStanHier()` function.

```{r, eval = FALSE}

#fitting a non-hierarchical Stan model
stan_model <- fitStan(data = batch_ids)
#you can use either the batch ID numbers or the output from readInData()
stan_model2 <- fitStan(data = comp_output)
```

`fitStan()` accepts the following arguments:

-   `email`: Character vector, the email address for the registered SentimentIt account.

-   `password`: Character vector, the password associated with `email`.

-   `data`: Numeric vector containing the batch IDs for the comparisons to be used in the model. Can also be a data frame containing the output from the `readInData()` function.

-   `chains`: Integer, the number of chains. (Default is 3).

-   `iter`: Numeric vector, the number of iteration. (Default is 2500).

-   `seed`: Set seed. (Defalt is 1234).

-   `n.cores`: Integer vector, the number of cores to be used in Stan fit (Default is 3).

Use Stan model to assess worker reliability
------


Once you have estimated a Stan model, you can use this to identify workers who are unreliable. You can use the output from the Stan model, as well as the output from the completed comparisons, to identify unreliable workers.

Use the `checkWorkers()` function to detect these outlying workers.

```{r, eval = FALSE}

ban_workers <- checkWorkers(stan_fit = stan_model, data = output) #the output object comes from the readInData() function
```

`fitStan()` accepts the following arguments:

-   `stan_fit`: A Stan model fit.

-   `data`: The data used to fit the Stan model.

-   `cut_point`: A cutoff point to classify posterior coefficients. The proportion of posterior coefficients below `cut_point` is used to determine outliers (Default is 1).

-   `cut_proportion`: A cutoff proportion of posterior coefficients below `cut_point`. If the proportion of posterior coefficients below `cut_points` is higher than `cut_proportion`, a worker will be considered as an outlier provided that she answers more than the number of questions in `n.questions` (Default is 0.9).

-   `n.questions`: The number of questions to consider in order to determine suggested banned workers (Default is 50).

-   `plot_hist`: If TRUE, plot the histogram of workers with a rug plot. Default is FALSE.

-   `hist_path`: Save the histogram to path and file name specified. Default is NULL and no plot is saved.